import AWS from 'aws-sdk';
import { randomUUID } from 'crypto';
import sharp from 'sharp';

// Configure AWS\nAWS.config.update({\n  accessKeyId: process.env.AWS_ACCESS_KEY_ID,\n  secretAccessKey: process.env.AWS_SECRET_ACCESS_KEY,\n  region: process.env.AWS_REGION || 'us-east-1',\n});\n\n// Create S3 instance\nexport const s3 = new AWS.S3();\n\n// S3 Configuration\nexport const S3_CONFIG = {\n  bucketName: process.env.AWS_S3_BUCKET_NAME || 'res-platform-files',\n  region: process.env.AWS_REGION || 'us-east-1',\n  maxFileSize: 10 * 1024 * 1024, // 10MB\n  allowedImageTypes: ['image/jpeg', 'image/png', 'image/webp', 'image/gif'],\n  allowedDocumentTypes: ['application/pdf', 'application/msword', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document'],\n  folders: {\n    contestants: 'contestants/',\n    users: 'users/',\n    documents: 'documents/',\n    temp: 'temp/',\n  },\n};\n\nexport interface UploadResult {\n  key: string;\n  url: string;\n  bucket: string;\n  fileName: string;\n  fileSize: number;\n  contentType: string;\n}\n\nexport interface ImageOptimizationOptions {\n  width?: number;\n  height?: number;\n  quality?: number;\n  format?: 'jpeg' | 'png' | 'webp';\n}\n\n// Generate unique file key\nexport function generateFileKey(folder: string, originalName: string, userId?: string): string {\n  const timestamp = Date.now();\n  const uuid = randomUUID();\n  const extension = originalName.split('.').pop() || 'bin';\n  const userPrefix = userId ? `${userId}/` : '';\n  return `${folder}${userPrefix}${timestamp}-${uuid}.${extension}`;\n}\n\n// Optimize image using Sharp\nexport async function optimizeImage(\n  buffer: Buffer,\n  options: ImageOptimizationOptions = {}\n): Promise<Buffer> {\n  const {\n    width = 1200,\n    height = 1200,\n    quality = 85,\n    format = 'jpeg',\n  } = options;\n\n  let sharpInstance = sharp(buffer)\n    .resize(width, height, {\n      fit: 'inside',\n      withoutEnlargement: true,\n    });\n\n  switch (format) {\n    case 'jpeg':\n      sharpInstance = sharpInstance.jpeg({ quality });\n      break;\n    case 'png':\n      sharpInstance = sharpInstance.png({ quality });\n      break;\n    case 'webp':\n      sharpInstance = sharpInstance.webp({ quality });\n      break;\n  }\n\n  return sharpInstance.toBuffer();\n}\n\n// Upload file to S3\nexport async function uploadToS3(\n  buffer: Buffer,\n  key: string,\n  contentType: string,\n  metadata: Record<string, string> = {}\n): Promise<UploadResult> {\n  const uploadParams = {\n    Bucket: S3_CONFIG.bucketName,\n    Key: key,\n    Body: buffer,\n    ContentType: contentType,\n    Metadata: metadata,\n    ServerSideEncryption: 'AES256',\n  };\n\n  try {\n    const result = await s3.upload(uploadParams).promise();\n    \n    return {\n      key: result.Key!,\n      url: result.Location!,\n      bucket: result.Bucket!,\n      fileName: key.split('/').pop() || key,\n      fileSize: buffer.length,\n      contentType,\n    };\n  } catch (error) {\n    console.error('S3 upload error:', error);\n    throw new Error('Failed to upload file to storage');\n  }\n}\n\n// Delete file from S3\nexport async function deleteFromS3(key: string): Promise<void> {\n  const deleteParams = {\n    Bucket: S3_CONFIG.bucketName,\n    Key: key,\n  };\n\n  try {\n    await s3.deleteObject(deleteParams).promise();\n  } catch (error) {\n    console.error('S3 delete error:', error);\n    throw new Error('Failed to delete file from storage');\n  }\n}\n\n// Generate pre-signed URL for client-side uploads\nexport function generatePresignedUrl(\n  key: string,\n  contentType: string,\n  expiresIn: number = 3600 // 1 hour\n): string {\n  return s3.getSignedUrl('putObject', {\n    Bucket: S3_CONFIG.bucketName,\n    Key: key,\n    ContentType: contentType,\n    Expires: expiresIn,\n  });\n}\n\n// Get file metadata from S3\nexport async function getFileMetadata(key: string) {\n  try {\n    const result = await s3.headObject({\n      Bucket: S3_CONFIG.bucketName,\n      Key: key,\n    }).promise();\n    \n    return {\n      contentType: result.ContentType,\n      contentLength: result.ContentLength,\n      lastModified: result.LastModified,\n      metadata: result.Metadata,\n    };\n  } catch (error) {\n    console.error('S3 metadata error:', error);\n    throw new Error('Failed to get file metadata');\n  }\n}\n\n// Validate file type\nexport function validateFileType(contentType: string, allowedTypes: string[]): boolean {\n  return allowedTypes.includes(contentType);\n}\n\n// Get file extension from content type\nexport function getExtensionFromContentType(contentType: string): string {\n  const typeMap: Record<string, string> = {\n    'image/jpeg': 'jpg',\n    'image/png': 'png',\n    'image/webp': 'webp',\n    'image/gif': 'gif',\n    'application/pdf': 'pdf',\n    'application/msword': 'doc',\n    'application/vnd.openxmlformats-officedocument.wordprocessingml.document': 'docx',\n  };\n  \n  return typeMap[contentType] || 'bin';\n}"