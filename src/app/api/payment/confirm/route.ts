import { NextRequest, NextResponse } from 'next/server';\nimport { getServerSession } from 'next-auth';\nimport { authOptions } from '@/lib/auth';\nimport { stripe } from '@/lib/stripe';\nimport { supabase } from '@/lib/supabase';\nimport { z } from 'zod';\nimport { randomUUID } from 'crypto';\n\nconst confirmPaymentSchema = z.object({\n  paymentIntentId: z.string(),\n});\n\nexport async function POST(req: NextRequest) {\n  try {\n    const session = await getServerSession(authOptions);\n    \n    if (!session?.user) {\n      return NextResponse.json(\n        { error: 'Authentication required' },\n        { status: 401 }\n      );\n    }\n\n    const body = await req.json();\n    const { paymentIntentId } = confirmPaymentSchema.parse(body);\n\n    // Retrieve payment intent from Stripe\n    const paymentIntent = await stripe.paymentIntents.retrieve(paymentIntentId);\n\n    if (paymentIntent.status !== 'succeeded') {\n      return NextResponse.json(\n        { error: 'Payment not completed' },\n        { status: 400 }\n      );\n    }\n\n    // Verify the payment belongs to the current user\n    if (paymentIntent.metadata.userId !== session.user.id) {\n      return NextResponse.json(\n        { error: 'Unauthorized' },\n        { status: 403 }\n      );\n    }\n\n    // Get payment record from database\n    const { data: payment, error: paymentError } = await supabase\n      .from('Payment')\n      .select('*')\n      .eq('stripePaymentIntentId', paymentIntentId)\n      .single();\n\n    if (paymentError || !payment) {\n      console.error('Payment record not found:', paymentError);\n      return NextResponse.json(\n        { error: 'Payment record not found' },\n        { status: 404 }\n      );\n    }\n\n    if (payment.status === 'COMPLETED') {\n      return NextResponse.json(\n        { message: 'Payment already processed', payment },\n        { status: 200 }\n      );\n    }\n\n    // Update payment status\n    const { error: updateError } = await supabase\n      .from('Payment')\n      .update({\n        status: 'COMPLETED',\n        paidAt: new Date().toISOString(),\n        updatedAt: new Date().toISOString(),\n      })\n      .eq('id', payment.id);\n\n    if (updateError) {\n      console.error('Error updating payment status:', updateError);\n      return NextResponse.json(\n        { error: 'Failed to update payment status' },\n        { status: 500 }\n      );\n    }\n\n    // Create vote record\n    const currentRound = Math.ceil(\n      (Date.now() - new Date('2025-01-01').getTime()) / (7 * 24 * 60 * 60 * 1000)\n    );\n\n    const { data: vote, error: voteError } = await supabase\n      .from('Vote')\n      .insert({\n        id: randomUUID(),\n        userId: session.user.id,\n        contestantId: payment.contestantId,\n        voteCount: payment.voteCount,\n        isPaid: true,\n        amount: payment.amount,\n        transactionId: paymentIntentId,\n        status: 'ACTIVE',\n        votingRound: currentRound,\n        createdAt: new Date().toISOString(),\n      })\n      .select()\n      .single();\n\n    if (voteError) {\n      console.error('Error creating vote record:', voteError);\n      return NextResponse.json(\n        { error: 'Failed to create vote record' },\n        { status: 500 }\n      );\n    }\n\n    return NextResponse.json({\n      success: true,\n      payment: {\n        id: payment.id,\n        amount: payment.amount,\n        voteCount: payment.voteCount,\n        status: 'COMPLETED',\n      },\n      vote,\n    });\n  } catch (error) {\n    console.error('Payment confirmation error:', error);\n    return NextResponse.json(\n      { error: 'Failed to confirm payment' },\n      { status: 500 }\n    );\n  }\n}"