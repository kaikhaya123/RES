import { NextRequest, NextResponse } from 'next/server';\nimport { getServerSession } from 'next-auth';\nimport { authOptions } from '@/lib/auth';\nimport { supabase } from '@/lib/supabase';\nimport { cacheGet, cacheSet, CACHE_TTL } from '@/lib/redis';\n\nexport async function GET(req: NextRequest) {\n  try {\n    const session = await getServerSession(authOptions);\n    \n    if (!session?.user) {\n      return NextResponse.json(\n        { error: 'Authentication required' },\n        { status: 401 }\n      );\n    }\n\n    const { searchParams } = new URL(req.url);\n    const page = parseInt(searchParams.get('page') || '1');\n    const limit = parseInt(searchParams.get('limit') || '20');\n    const status = searchParams.get('status');\n    \n    const cacheKey = `payment:history:${session.user.id}:${page}:${limit}:${status || 'all'}`;\n    \n    // Try cache first\n    const cached = await cacheGet(cacheKey);\n    if (cached) {\n      return NextResponse.json(cached);\n    }\n\n    let query = supabase\n      .from('Payment')\n      .select(\n        `\n        id,\n        amount,\n        currency,\n        voteCount,\n        packageType,\n        status,\n        paidAt,\n        failureReason,\n        createdAt,\n        Contestant!Payment_contestantId_fkey (\n          id,\n          firstName,\n          lastName,\n          photoUrl\n        )\n        `,\n        { count: 'exact' }\n      )\n      .eq('userId', session.user.id);\n\n    if (status) {\n      query = query.eq('status', status.toUpperCase());\n    }\n\n    const { data: payments, count, error } = await query\n      .range((page - 1) * limit, page * limit - 1)\n      .order('createdAt', { ascending: false });\n\n    if (error) {\n      console.error('Error fetching payment history:', error);\n      return NextResponse.json(\n        { error: 'Failed to fetch payment history' },\n        { status: 500 }\n      );\n    }\n\n    // Calculate total spent\n    const { data: totals, error: totalsError } = await supabase\n      .from('Payment')\n      .select('amount, voteCount')\n      .eq('userId', session.user.id)\n      .eq('status', 'COMPLETED');\n\n    const summary = {\n      totalSpent: totals?.reduce((sum, p) => sum + p.amount, 0) || 0,\n      totalVotesPurchased: totals?.reduce((sum, p) => sum + p.voteCount, 0) || 0,\n      totalTransactions: totals?.length || 0,\n    };\n\n    const result = {\n      payments: payments || [],\n      total: count || 0,\n      page,\n      limit,\n      totalPages: Math.ceil((count || 0) / limit),\n      summary,\n    };\n\n    // Cache for 5 minutes\n    await cacheSet(cacheKey, result, CACHE_TTL.SHORT);\n\n    return NextResponse.json(result);\n  } catch (error) {\n    console.error('Payment history error:', error);\n    return NextResponse.json(\n      { error: 'Failed to fetch payment history' },\n      { status: 500 }\n    );\n  }\n}"